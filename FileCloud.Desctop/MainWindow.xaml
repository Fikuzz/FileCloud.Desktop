<Window x:Class="FileCloud.Desktop.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:FileCloud.Desktop"
        xmlns:helpers="clr-namespace:FileCloud.Desktop.Helpers"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:vm="clr-namespace:FileCloud.Desktop.ViewModels;assembly=FileCloud.Desktop.ViewModels"
        xmlns:conv="clr-namespace:FileCloud.Desktop.View.Converters"
        xmlns:behav="clr-namespace:FileCloud.Desktop.View.Behaviors"
        mc:Ignorable="d"
        Title="MainWindow" Height="450" Width="800">
    <!-- Styles -->
    <FrameworkElement.Resources>
        <ResourceDictionary>
            <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <!--Button style-->
            <Style
				TargetType="{x:Type Button}"
				x:Key="{x:Type Button}">
                <Setter
					Property="Margin"
					Value="5" />
                <Setter
					Property="Padding"
					Value="10,5" />
                <Setter
					Property="FontWeight"
					Value="SemiBold" />
            </Style>
            <!--TextBlock style-->
            <Style
				TargetType="{x:Type TextBlock}"
				x:Key="{x:Type TextBlock}">
                <Setter
					Property="FontSize"
					Value="14" />
                <Setter
					Property="TextWrapping"
					Value="Wrap" />
            </Style>
        </ResourceDictionary>
    </FrameworkElement.Resources>
    <DockPanel>
        <!-- Hat -->
        <Border
			DockPanel.Dock="Top"
			Background="#FF2C3E50"
			Padding="10">
            <DockPanel>
                <TextBlock
					Text="👤 Гость"
					Foreground="#FFFFFFFF"
					FontSize="16"
					FontWeight="Bold" />
            </DockPanel>
        </Border>
        <!-- Status messages -->
        <StatusBar
			DockPanel.Dock="Bottom">
            <StatusBarItem>
                <TextBlock
					Name="StatusBarText"
					Text="{Binding StatusMessage}" />
            </StatusBarItem>
        </StatusBar>
        <DockPanel>
            <!-- Buttons panel -->
            <DockPanel
				Dock="Left"
				Width="200"
				Background="#FFF0F0F0">
                <Button
					Content="Обновить"
					DockPanel.Dock="Bottom"
					Command="{Binding LoadFolderChildsCommand}"/>
                <StackPanel>
                    <Button
						Content="📤 Загрузить файл"
						Command="{Binding UploadFileCommand}" />
                    <Button
						Content="📥 Скачать файл"
						Command="{Binding SaveFilesCommand}" />
                    <Button
						Content="❌ Удалить файл"
						Command="{Binding DeleteFilesCommand}" />
                </StackPanel>
            </DockPanel>
            <DockPanel>
                <DockPanel DockPanel.Dock="Top">
                    <ItemsControl ItemsSource="{Binding FolderPath}">
                        <ItemsControl.Resources>
                            <behav:BindingProxy x:Key="Proxy" Data="{Binding}"/>
                        </ItemsControl.Resources>
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type vm:FolderViewModel}">
                                <StackPanel Orientation="Horizontal">
                                    <Button Content="{Binding Name}"
                                            Command="{Binding Source={StaticResource Proxy}, Path=Data.LoadFolderChildsCommand}"
                                            CommandParameter="{Binding}"
                                            FontSize="13"
                                            BorderThickness="0"
                                            Margin="0"
                                            Padding="4"
                                            Background="White"/>
                                    <TextBlock Text="/" 
                                            Margin="0"
                                            VerticalAlignment="Center"
                                            FontSize="18"
                                            Visibility="{Binding RelativeSource={RelativeSource AncestorType=ContentPresenter},
                                                Path=IsLastItem, 
                                                Converter={StaticResource BoolToVisibilityConverter}}"/>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </DockPanel>
                <DockPanel>
                    <TextBlock/>
                    <ScrollViewer
				VerticalScrollBarVisibility="Auto"
				HorizontalScrollBarVisibility="Disabled">
                        <!-- Item List -->
                        <ListBox
					SelectionMode="Extended"
					BorderThickness="0"
					Background="#00FFFFFF"
					HorizontalAlignment="Stretch"
					ScrollViewer.HorizontalScrollBarVisibility="Disabled"
					ScrollViewer.VerticalScrollBarVisibility="Auto"
					ItemsSource="{Binding Items}"
					helpers:ListBoxSelectedItemsBinding.BindableSelectedItems="{Binding SelectedFiles}" d:ItemsSource="{d:SampleData ItemCount=5}" BorderBrush="#FF909090">
                            <!-- Контекстное меню ListBox -->
                            <ListBox.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="New folder"
                                      Command="{Binding CreateFolderCommand}"/>
                                </ContextMenu>
                            </ListBox.ContextMenu>
                            <ListBox.Resources>
                                <behav:BindingProxy x:Key="Proxy" Data="{Binding}"/>
                                <!-- Шаблон для файлов -->
                                <DataTemplate DataType="{x:Type vm:FileViewModel}">
                                    <StackPanel>
                                        <!-- Обработка нажатий мыши\клавиатуры -->
                                        <StackPanel.InputBindings>
                                            <MouseBinding MouseAction="LeftDoubleClick"
                                        Command="{Binding PlacementTarget.Tag.FileOpenCommand,
                                        RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                        CommandParameter="{Binding}" />
                                        </StackPanel.InputBindings>
                                        <!-- Контекстное меню файла -->
                                        <StackPanel.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="Open" Command="{Binding OpenFileCommand}" 
                                            CommandParameter="{Binding RelativeSource={RelativeSource 
                                                Mode=FindAncestor, 
                                                AncestorType=ContextMenu}, 
                                                Path=PlacementTarget.DataContext}"/>
                                                <MenuItem Header="Save" 
                                            Command="{Binding SaveFileCommand}"/>
                                                <MenuItem Header="Edit" 
                                            Command="{Binding UpdateFileCommand}"/>
                                                <Separator/>
                                                <MenuItem Header="Delete" 
                                            Command="{Binding DeleteCommand}"/>
                                            </ContextMenu>
                                        </StackPanel.ContextMenu>
                                        <!-- Внешний вид файла -->
                                        <Border BorderBrush="#CCC" BorderThickness="1" Margin="3"
                                    Width="120" Padding="4" CornerRadius="10">
                                            <Image Width="100" Height="100">
                                                <Image.Style>
                                                    <Style TargetType="Image">
                                                        <Setter Property="Source" Value="{Binding PreviewPath}" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding PreviewPath}" Value="{x:Null}">
                                                                <Setter Property="Source" Value="{Binding PreviewImage}" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Image.Style>
                                            </Image>
                                        </Border>
                                        <Grid>
                                            <!-- Показываем TextBlock, если НЕ редактируем -->
                                            <TextBlock Text="{Binding Name}"
                                        Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}"
                                        HorizontalAlignment="Center"
                                        Margin="4"
                                        Cursor="Hand">
                                        <!-- Двойной клик запускает команду Rename -->
                                                <TextBlock.InputBindings>
                                                    <MouseBinding Gesture="LeftDoubleClick"
                                                Command="{Binding RenameCommand}" />
                                                </TextBlock.InputBindings>
                                            </TextBlock>

                                            <!-- Показываем TextBox, если редактируем -->
                                            <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                        Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}"
                                        Margin="4"
                                        HorizontalContentAlignment="Center"
                                        HorizontalAlignment="Stretch"
                                        behav:EditableTextBehavior.EnableCommitCancel="True"
                                        behav:FocusBehavior.IsFocused="{Binding IsEditing}">
                                                <i:Interaction.Triggers>
                                                    <i:EventTrigger EventName="LostFocus">
                                                        <i:InvokeCommandAction Command="{Binding CommitEditCommand}" />
                                                    </i:EventTrigger>
                                                </i:Interaction.Triggers>
                                            </TextBox>
                                        </Grid>
                                    </StackPanel>
                                </DataTemplate>
                                <!-- Шаблон для папок -->
                                <DataTemplate DataType="{x:Type vm:FolderViewModel}">
                                    <StackPanel>
                                        <!-- Обработка нажатий мыши\клавиатуры -->
                                        <StackPanel.InputBindings>
                                            <MouseBinding MouseAction="LeftDoubleClick"
                                        Command="{Binding DataContext.LoadFolderChildsCommand,
                                            RelativeSource={RelativeSource AncestorType=ListBox}}"
                                        CommandParameter="{Binding}" />
                                        </StackPanel.InputBindings>
                                        <!-- Контекстное меню папки -->
                                        <StackPanel.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="Open"
                                            Command="{Binding Source={StaticResource Proxy}, Path=Data.LoadFolderChildsCommand}"
                                            CommandParameter="{Binding}" />
                                                <MenuItem Header="Rename"
                                            Command="{Binding RenameCommand}" />
                                                <Separator/>
                                                <MenuItem Header="Delete"
                                            Command="{Binding DeleteCommand}" />
                                            </ContextMenu>
                                        </StackPanel.ContextMenu>

                                        <!-- Внешний вид папки -->
                                        <Border BorderBrush="#CCC" BorderThickness="1" Margin="3"
                                    Width="120" Padding="4" CornerRadius="10">
                                            <Image Width="100" Height="100">
                                                <Image.Style>
                                                    <Style TargetType="Image">
                                                        <Setter Property="Source" Value="{Binding PreviewPath}" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding PreviewPath}" Value="{x:Null}">
                                                                <Setter Property="Source" Value="{Binding PreviewImage}" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Image.Style>
                                            </Image>
                                        </Border>

                                        <Grid>
                                            <!-- Показываем TextBlock, если НЕ редактируем -->
                                            <TextBlock Text="{Binding Name}"
                                        Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}"
                                        HorizontalAlignment="Center"
                                        Margin="4"
                                        Cursor="Hand">
                                        <!-- Двойной клик запускает команду Rename -->
                                                <TextBlock.InputBindings>
                                                    <MouseBinding Gesture="LeftDoubleClick"
                                                Command="{Binding RenameCommand}" />
                                                </TextBlock.InputBindings>
                                            </TextBlock>

                                            <!-- Показываем TextBox, если редактируем -->
                                            <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                        Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}"
                                        Margin="4"
                                        HorizontalContentAlignment="Center"
                                        HorizontalAlignment="Stretch"
                                        behav:EditableTextBehavior.EnableCommitCancel="True"
                                        behav:FocusBehavior.IsFocused="{Binding IsEditing}">
                                                <i:Interaction.Triggers>
                                                    <i:EventTrigger EventName="LostFocus">
                                                        <i:InvokeCommandAction Command="{Binding CommitEditCommand}" />
                                                    </i:EventTrigger>
                                                </i:Interaction.Triggers>
                                            </TextBox>
                                        </Grid>
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.Resources>
                            <ListBox.InputBindings>
                                <KeyBinding Key="Delete"
                            Command="{Binding DeleteFilesCommand}"
                            CommandParameter="{Binding SelectedItem, RelativeSource={RelativeSource AncestorType=ListBox}}" />
                            </ListBox.InputBindings>
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ListBox>
                    </ScrollViewer>
                </DockPanel>
            </DockPanel>
        </DockPanel>
    </DockPanel>
</Window>