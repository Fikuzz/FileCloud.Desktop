<UserControl x:Class="FileCloud.Desktop.View.FileItemView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:behav="clr-namespace:FileCloud.Desktop.View.Behaviors"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:FileCloud.Desktop.View"
             xmlns:conv="clr-namespace:FileCloud.Desktop.View.Converters"
             mc:Ignorable="d" Height="140" Width="130">
    <FrameworkElement.Resources>
        <ResourceDictionary>
            <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        </ResourceDictionary>
    </FrameworkElement.Resources>
    <StackPanel>
        <!-- Обработка нажатий мыши\клавиатуры -->
        <StackPanel.InputBindings>
            <MouseBinding MouseAction="LeftDoubleClick"
                                        Command="{Binding PlacementTarget.Tag.FileOpenCommand,
                                        RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                        CommandParameter="{Binding}" />
        </StackPanel.InputBindings>
        <!-- Контекстное меню файла -->
        <StackPanel.ContextMenu>
            <ContextMenu>
                <MenuItem Header="Open" Command="{Binding OpenFileCommand}" 
                                            CommandParameter="{Binding RelativeSource={RelativeSource 
                                                Mode=FindAncestor, 
                                                AncestorType=ContextMenu}, 
                                                Path=PlacementTarget.DataContext}"/>
                <MenuItem Header="Save" 
                                            Command="{Binding SaveFileCommand}"/>
                <MenuItem Header="Edit" 
                                            Command="{Binding UpdateFileCommand}"/>
                <Separator/>
                <MenuItem Header="Delete" 
                                            Command="{Binding DeleteCommand}"/>
            </ContextMenu>
        </StackPanel.ContextMenu>
        <!-- Внешний вид файла -->
        <Border BorderBrush="#CCC" BorderThickness="1" Margin="3"
                                    Width="120" Padding="4" CornerRadius="10">
            <Image Width="100" Height="100">
                <Image.Style>
                    <Style TargetType="Image">
                        <Setter Property="Source" Value="{Binding PreviewPath}" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding PreviewPath}" Value="{x:Null}">
                                <Setter Property="Source" Value="{Binding PreviewImage}" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Image.Style>
            </Image>
        </Border>
        <Grid>
            <!-- Показываем TextBlock, если НЕ редактируем -->
            <TextBlock Text="{Binding Name}"
                                        Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}"
                                        HorizontalAlignment="Center"
                                        Margin="4"
                                        Cursor="Hand">
                                        <!-- Двойной клик запускает команду Rename -->
                <TextBlock.InputBindings>
                    <MouseBinding Gesture="LeftDoubleClick"
                                                Command="{Binding RenameCommand}" />
                </TextBlock.InputBindings>
            </TextBlock>

            <!-- Показываем TextBox, если редактируем -->
            <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                        Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}"
                                        Margin="4"
                                        HorizontalContentAlignment="Center"
                                        HorizontalAlignment="Stretch"
                                        behav:EditableTextBehavior.EnableCommitCancel="True"
                                        behav:FocusBehavior.IsFocused="{Binding IsEditing}">
                <i:Interaction.Triggers>
                    <i:EventTrigger EventName="LostFocus">
                        <i:InvokeCommandAction Command="{Binding CommitEditCommand}" />
                    </i:EventTrigger>
                </i:Interaction.Triggers>
            </TextBox>
        </Grid>
    </StackPanel>
</UserControl>
